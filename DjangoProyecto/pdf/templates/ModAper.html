{% extends 'base.html' %}
{%block body%}

<h2> Panel de Modificaci√≥n de apercibimientos. </h2>
<h6> Este panel permite seleccionar los apercibimientos, permitiendo su busqueda por curso y alumno para ignorar dichos apercibimientos en la generacion de informes. </h6>
 
<div class="form-group" style="margin-top:30px;margin-left:20px;">
        <form enctype="multipart/form-data" method="post" >
              {% csrf_token %} 

<div class="form-group"> <!-- State Button -->
    <label for="id_Curso" class="control-label">Cursos</label>
    <select class="form-control" id="id_Mes" name="Curso">
        {% for ele in curso %}
       <option  onclick="BuscarAlumnos('{{ele}}')" value="{{ele}}">{{ele}}</option>
       {%endfor%}       
    </select> 
</div>

<div class="form-group"> <!-- State Button -->
    <label for="id_Alumno" class="control-label">Alumnos</label>
    <select class="form-control" id="id_Alumno" name="Alumno" disabled>
        
    </select> 

</div>

<input type="submit" value="Buscar" class="btn btn-default" id="Buscar" style="margin-top:10px;"/ disabled>
</form>

<p></p> 
<h3>Modificando Alumno/a : {{Alumno}}</h3>
<h6> Seleccione los apercibimientos del alumno para cambia su estado, los que esten en estado apercibimiento cambiaran a ignorado y viceversa. </h6>

<form enctype="multipart/form-data" method="post" >
    {% csrf_token %} 

<table class="table">
        <thead>
          <tr>
            <th>Materia</th>
            <th>Fecha Inicial</th>
            <th>Fecha Final</th>
            <th>Estado</th>
            <th>Cambiar Estado</th>
          </tr>
        </thead>

        {% for ele in AperIgnorado %}
        <tr>
          <th>{{ele.Materia}}</th>
          <th>{{ele.FechaDesde}}</th>
          <th>{{ele.FechaHasta}}</th>
          <th>{{ele.Estado}}</th>
          <th> <input type="checkbox" class="checkbox" name="{{ele.id}}" value="Apercibimiento" onclick="IgnorarSumbit()" /> </th>
        </tr>
        {%endfor%}

        {% for ele in AperAlumno %}
        <tr>
          <th>{{ele.Materia}}</th>
          <th>{{ele.FechaDesde}}</th>
          <th>{{ele.FechaHasta}}</th>
          <th>{{ele.Estado}}</th>
          <th> <input type="checkbox" class="checkbox" name="{{ele.id}}" value="Igonorar" onclick="IgnorarSumbit()" /> </th>
        </tr>
        {%endfor%}

</table>

<input type="submit" value="Cambiar Apercibimientos" class="btn btn-default" id="Ignorar" style="margin-top:10px;"/ disabled>
</form>

<script>
 
 // Desbloquea el boton Ignorar Apercibimientos
function IgnorarSumbit () {
    document.getElementById("Ignorar").removeAttribute("disabled");  
}

// Bloqueamos los componentes para preservar un orden.
document.getElementById("Ignorar").setAttribute("disabled","disabled");
document.getElementById("Buscar").setAttribute("disabled","disabled");
document.getElementById("id_Alumno").setAttribute("disabled","disabled");
var Alumnos = [];

function BuscarAlumnos (Curso) {

    // Esta funcion impide que se introduzca un alumno repetido dentro del formulario

    function repetido (Alumno,Alumnos) {
        var salida = true;
        for (let a = 0; a < Alumnos.length; a++) {
            if (Alumnos[a] === Alumno){
                salida = false;
            }        
        }
        return salida;
    }

    // Recoriendo el Json en busca de los alumnos que corespondan con la materia selecionada

    $.getJSON("/apirest/FaltasAsistencia/?format=json",function(data){
    for (let i = 0; i < data.length; i++) {
        if (data[i]["Curso"] === Curso ){
            if (repetido(data[i]["Alumno"],Alumnos))
                    Alumnos.push(data[i]["Alumno"]);
            }          
        }
    });


    // Creando Html con cada Alumno y Desbloqueando el boton de buscar


    var texto = '';
    for (let a = 0; a < Alumnos.length; a++) {
        texto = texto + " " + "<option value=\"" + Alumnos[a] + "\"" + " onclick='BuscarEnable()'>" + Alumnos[a] + "</option>";        
    }
    document.getElementById("id_Alumno").innerHTML = "";    
    document.getElementById("id_Alumno").innerHTML = texto;    
    document.getElementById("id_Alumno").removeAttribute("disabled");   
}

// Desbloquea el boton buscar.

function BuscarEnable(){
    document.getElementById("Buscar").removeAttribute("disabled");   
}
</script>
            
{%endblock%}
